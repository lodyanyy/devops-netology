# Домашняя работа к занятию "7.3. Основы и принцип работы Терраформ"

## Задача 1. Создадим бэкэнд в S3 (необязательно, но крайне желательно).

Если в рамках предыдущего задания у вас уже есть аккаунт AWS, то давайте продолжим знакомство со взаимодействием
терраформа и aws. 

1. Создайте s3 бакет, iam роль и пользователя от которого будет работать терраформ. Можно создать отдельного пользователя,
а можно использовать созданного в рамках предыдущего задания, просто добавьте ему необходимы права, как описано 
[здесь](https://www.terraform.io/docs/backends/types/s3.html).
1. Зарегистрируйте бэкэнд в терраформ проекте как описано по ссылке выше. 

## Решение 
Создал бакет через консоль ЯО,
роль и пользователя `$ yc resource-manager folder add-access-binding b1gem8suj95s5qrc1va1 --role editor --subject serviceAccount:ajepare9k00f1qq8pu83`


## Задача 2. Инициализируем проект и создаем воркспейсы. 

1. Выполните `terraform init`:
    * если был создан бэкэнд в S3, то терраформ создат файл стейтов в S3 и запись в таблице 
dynamodb.
    * иначе будет создан локальный файл со стейтами.  
1. Создайте два воркспейса `stage` и `prod`.
1. В уже созданный `aws_instance` добавьте зависимость типа инстанса от вокспейса, что бы в разных ворскспейсах 
использовались разные `instance_type`.
1. Добавим `count`. Для `stage` должен создаться один экземпляр `ec2`, а для `prod` два. 
1. Создайте рядом еще один `aws_instance`, но теперь определите их количество при помощи `for_each`, а не `count`.
1. Что бы при изменении типа инстанса не возникло ситуации, когда не будет ни одного инстанса добавьте параметр
жизненного цикла `create_before_destroy = true` в один из рессурсов `aws_instance`.
1. При желании поэкспериментируйте с другими параметрами и рессурсами.

## Решение
Для примерного повторения действий для Yandex Cloud создал [main.tf](https://github.com/lodyanyy/devops-netology/blob/main/07-terraform-03-basic/terraform/main.tf), где в зависимости от выбранного воркспейса создается ВМ с оригинальным навзванием и отличающимся количеством ядер и памятью.
![image](https://user-images.githubusercontent.com/87534423/180473356-39134ccd-10ac-4736-aafa-296b5039f5fe.png)
![image](https://user-images.githubusercontent.com/87534423/180482653-53b6427b-2fb4-4ee1-bf9f-7791cf94f8a0.png)

* Вывод команды `terraform workspace list`
```
lodyanyy@lodyanyy:~/netology/07-terraform-03-basic/cloud-terraform$ terraform workspace list
  default
* prod
  stage
```  
* Вывод команды [`terraform plan`](https://github.com/lodyanyy/devops-netology/blob/main/07-terraform-03-basic/terraform_plan.md) для воркспейса `prod`.  


